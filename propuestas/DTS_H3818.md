# #DTS #H3818 Generación de datos para informe Envalora - MITERD

Los objetivos de este proyecto son:
+ Incluir en el catálogo de productos aquellos datos referentes a los tipos y composición de envases necesarios para emitir el informe _Envalora_.
+ Disponer de una acción para emitira a hoja de cálculo dichos datos relativos a un determinado período de tiempo.

## Estructura

### Principal / Provincias
Añadiremos una tabla de comunidades autónomas y un nuevo campo en provincias:
+ Comunidad. Comunidad autónoma relacionada.

### Almacén / Artículos
Para aquellos artículos que son envases, crearemos un nuevo campo:
+ Tipo de envase. Sus posibles valores son:
    + (Vacío). No se trata de un envase
    + Aerosoles
    + Botella
    + Botellas
    + Tubo/Cartucho
    + Cubo/Bote/Lata/Tarro/Tarrina (boca ancha)
    + Jerrican/Garrafa
    + Bidón/Barril/Bombona (boca ancha)
    + Caja
    + Octabin/Palots/Palot plegable
    + Cocio/Envases abierto con o sin tapa
    + Bolsa
    + Saco monomaterial
    + Saco mixtos
    + Big-bag abierto
    + Big-bag con tapas o válvulas
    + Brick/Bolsa con válvula, bag in box/Politainer/Doy-pack
    + Contenedor IBC/GRG/Cubicontainer
    + Palé/Palet/Pallet/Paleta
    + Mandril/Rodrillo/Carrete
    + Film estirable/Film flexible/Film retráctil
    + Fundas/Mallas/Flow-pack
    + Separadores de capa/Barqueta/Bandeja
    + Fleje/Cintas/Abrazadera/Cordel
    + Cantonera/Elemento de fijación/de protección/de seguridad
    + Otros

### Informes facturación / Envalora MITERD
Crearemos una nueva opción de menú que permitirá indicar los datos del informe. Los criterios de búsqueda serán:
+ Intervalor de fechas.

El informe dispondrá de un botón:
+ Generar hoja de cálculo. Genera un informe como el de la plantilla.

## Precondiciones

## Dinámica

### Configurar la composición de un envase:

+ Vamos a la ficha del artículo (envase), a su pestaña _Composición / Escandallo_.
+ En el nuevo campo _Tipo de envase_ escogemos un valor distinto de _(Vacío)_.
    + Se cierra la tabla de composición normal y se abre una nueva tabla de composición de envase con las siguientes columnas:
        + Material.
        + % Composición.
        + % Reciclable (solo activo para material _Plastico_).
        + Tipo de plástico (solo activo para material _Plastico_).
    + Se creará automáticamente una fila para cada uno de estos tipos de material, con _% Composición_ = 0%:
        + Acero
        + Aglomerado de madera,fibras de madera,mdf,corcho
        + Aluminio
        + Caucho
        + Cuero
        + Madera
        + Metal,hojalata
        + Otros
        + Otros metales
        + Papel,cartón
        + Plástico
        + Textil
        + Vidrio, porcelana, gres
        + Cartón para bebidas y alimentos
        + Vidrio fabricado con sosa y cal
        + Otros metales (no ferrosos)

+ El usuario indicará los porcentajes de composición de los componentes del envase, que tienen que totalizar un 100%. La forma de hacer esto será:
    + Indicando de forma manual el valor del campo _% Composición_.
    + Haciendo dobre clic sobre la columna del tipo de material. En este caso, el valor de _% Composición_ se calculará como el restante de 100 menos el total acumulado. Ejemplos:
        + Si un envase está compuesto 100% de madera, hacemos doble clic sobre Madera.
        + Si un envase está compuesto 40% de cuero, 60% de madera, indicamos 40% en _% Composición_ de la fila de _Cuero_ y hacemos doble clic en la de _Madera_ para que automáticamente se indique el 60% restante.
    + Las filas con _% Composición_ distinto de 0 se destacarán mediante un color especial del resto.
+ Si se indica _% Composición_ en el material _Plástico_, el usuario podrá hacer doble clic en la celda de _Tipo de plástico_. Se abrirá un formulario de selección de tipo de plástico con las siguientes opciones:
    + EPS(Expandido)
	+ HDPE(Blanco o natural)
	+ HDPE resto colores
	+ LDPE
	+ Otros plásticos
	+ PET sin color
	+ PET con color
	+ Plástico compostable (EN 13432:2001)
	+ PP
	+ PS
	+ PU
	+ PVC
	+ XPS (Extruido)
	+ PS-E

### Validaciones
El formulario de artículo no podrá guardarse si los _% Composición_ no suman 100.
Si se indica _% Composición_ en el material _Plástico_, será necesario establecer el _Tipo de plástico_ y su _% Reciclable_ (valor entre 0 y 100)

## Notas de desarrollo
Incluir extensión de comunidades autónomas.

Precálculo de datos:
1. Lista de todos los productos vendidos en el intervalo
1. Para cada producto:
    + Peso total de sus envases = suma de peso de cada envase x factor de composición.
    + Tipos de envase. Para cada tipo
        + Peso total del tipo de envase (deben sumar el peso total de envases). Es suma de peso de cada envase x factor de composición para cada tipo.

SELECT p.idcomunidad, p.idprovincia, a.referencia, SUM(lf.cantidad) FROM facturascli f
INNER JOIN lineasfacturascli lf ON f.idfactura = lf.idfactura
LEFT OUTER JOIN articulos a ON lf.referencia = a.referencia
LEFT OUTER JOIN dirclientes dc ON f.codcliente = dc.dircliente AND dc.domfacturacion
LEFT OUTER JOIN provincas p on dc.idprovincia = p.idprovincia
GROUP BY p.idcomunidad, p.idprovincia, a.referencia

Modelo de datos para guardar composiciones:
Tabla dts_materialesenvase
    + id
    + referencia
    + material
    + % mat
    + tipoplastico
    + % reciclable

# Comprobaciones
Todas las provincias españolas tienen su comunidad autónoma indicada.
Todas las direcciones de facturación de cliente tienen su provincia indicada.
Todos los clientes tienen una (y solo una) dirección de facturación.


## Manual
El manual constará de...
No es necesario manual

## Presupuesto
### Análisis X€
### Desarrollo X€
### Documentación X€