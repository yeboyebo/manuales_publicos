# #DUM #H4532 Descuentos y totales en partidas

Los objetivos de este proyecto son:
+ Poder asignar descuentos a partidas completas
+ Poder consultar el total de cada partida

## Propuesta realizada a petición de:
Cristina

## Estructura

### Partidas. Nuevos campos
Añadiremos a la pantalla los siguientes controles:

+ Importe. Total de importe sin descuento de las líneas asociadas a la partida.
+ Descuento. Porcentaje de descuento a aplicar.
+ Total. Total de líneas asociadas a la partida

### Partidas. Cambio de porcentaje de descuento
Cuando cambiamos el porcentaje de descuento de una partida, se revisará el campo de porcentaje en todas sus líneas para establecer el valor de la partida.

### Partidas. Alta y edición de líneas con partida de descuento.
Cuando se crea una línea asociada a una partida con descuento, el descuento porcentual de la línea será igual al de la partida y no se podrá modificar. Tampoco se podrá modificar el descuento lineal.

### Partidas. Modificaciones en líneas
Si una línea asociada a una partida cambia su precio total, se crea o se borra, el total de su línea se recalcula.

### Partidas. Copia
Cuando una partida se copia, sus datos de descuento y total se copian

### Partidas. Paso de documento
Cuando una partida pasa de presupuesto a pedido, de pedido a albarán o de albarán a factura, copia su descuento y recalcula (en albaranado parcial) / copia su total

### Partidas. Informe de presupuestos por partida
Incluiremos los datos de totales y descuento en el informe de presupuestos por partida

### Partidas. Informe de facturas por partida
Incluiremos los datos de totales y descuento en el informe de facturas por partida

## Notas de desarrollo
```js
afterCommit_partidas > revisionDecuentoPartida

revisionDecuentoPartida >
if descuentoCambia() revisarDescuentoLineasPartida

revisarDescuentoLineasPartida >
while (curLinea.next()) {
    curLinea.setValueBuffer("dtopor", dtoPor);
    curLinea.setValueBuffer("dtolineal", 0)
    _i.totalizarConDescuento(); // Tiene en cuenta IVA incluido
}
_i.calcularTotalesCursor(curVenta)

afterCommit_lineasX > revisionTotalPartida

revisionTotalPartida > 
if totalesCambian() > totalizarPartida

totalizarPartida...
```

## Tareas
* #DUM #H4532. Partidas. Nuevos campos
* #DUM #H4532. Partidas. Cambio de porcentaje de descuento
* #DUM #H4532. Partidas. Modificaciones en líneas
* #DUM #H4532. Partidas. Copia
* #DUM #H4532. Partidas. Paso de documento
* #DUM #H4532. Partidas. Informe de presupuestos por partida
* #DUM #H4532. Partidas. Informe de facturas por partida

## Manual
No es necesario manual

## Asistencia a puesta en marcha
No es necesaria.

