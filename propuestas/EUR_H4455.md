# #EUR #H4455#SPRINT 2025 #P0088 - CONTRACT - Mejora en el tratamiento de Lotes de piezas

Los objetivos de este proyecto son:
+ Poder realizar movimientos de lote entre almacenes identificando correctamente cada lote, el almacén donde está y su origen

## Propuesta realizada a petición de:
José Ruiz

## Estructura

### Aumento de lotes a 15 caracteres y criterios de agregación del sufijo de almacén
Aumentaremos el tamaño del campo de código de lote en la tabla de lotes y todas las tablas asociadas de 10 a 15 caracteres.


### Informes afectados.
Revisaremos los siguientes informes para comprobar que los códigos largos se ven correctamente:
Informes (correo de JRuiz):
    + Impreso de la Etiqueta de piezas. Será necesario comprobar que el código de barras largo no pisa los datos de albarán / Partida, ya que debe comenzar más a la izquierda
    + Informes de albaranes de venta que llevan tejido, versiones con o sin membrete y nacional y export
    + Informes de albaranes de compra que llevan tejido


### Nueva pantalla de transferencia de piezas
(Ver pantallazo del correo de JRuiz)

A partir de la pantalla de TRANSFERENCIAS DE STOCKS, generaremos una nueva pantalla de TRANSFERENCIAS DE PIEZAS, ya que la interfaz  y su informe asociado son muy similares.
    + Grid (maestro) de transferencia de piezas. Mismas columnas. El informe mostrará un informe copiado del de transferencia de stocks.

    + Formulario de edición

        + Eliminamos botón _Automáticas_
        + Eliminamos columnas _Partida_ y _Forzar nuevo lote..._

        + Agregamos botón _Asignar piezas_
        + Agregamos columna _Pieza_

    + Líneas de transferencia de piezas
        + El campo _pieza_ es obligatorio. Solo permitirá selección de lotes tipo pieza

    + Movimientos de stock asociados a líneas de transferencias de piezas:
        + Movimiento de origen
            + idstock: El de la referencia y almacén origen
            + cantidad: Cantidad de la línea en negativo
            + lote: Código de pieza origen
            + concepto: Transferencia Nº[X] de pieza desde [código almacén origen] hasta [código almacén destino] Pieza Destino [código pieza destino]

        + Movimiento de destino
            + idstock: El de la referencia y almacén destino
            + cantidad: Cantidad de la línea en positivo
            + lote: Código de pieza destino
            + concepto: Transferencia Nº[X] de pieza desde [código almacén origen] hasta [código almacén destino] Pieza Origen [código pieza origen]
    
### Lógica de creación de lote en almacén destino
Pasos:
    + Obtenemos el código de lote sin almacén (10 primeros caracteres o parte a la izquierda del punto)
    + Comprobamos si existe un lote con dicho código para el almacén destino (campo codalmacen de lotesstock)
        + Si el lote existe, tomamos dicho código de lote
        + Si el lote no existe
            + Ccalculamos el nuevo código de lote como:
                + 10 primeros dígitos del código de lote origen
                + "."
                + Código del almacén de destino
            + Comprobamos si el existe un lote con el código calculado para el almacén destino
                + Si existe, usamos el lote encontrado
                + Si no existe, creamos el lote y usamos el nuevo lote

Notas JRuiz:

_Si en lotesstock existe ya un codlote de 10 caracteres, entonces en el alm. destino obligatoriamente el nuevo codlote tiene llevar el .codalmacen en el codlote (codlotede10digitos.codalmacendestino)_

_Si el origen tiene más de 10 caracteres hay que calcular el de 10 dígitos y ver si hay que montar otro codlote de más de 10 caracteres con el codalmacen destino (codlotede10digitos.codalmacendestino)_

 _En el ejemplo rápido  de arriba:_
    _Una pieza PZ00762776 de alm. 3 nacida de rolladora al alm. de saldo 3, si se traspasa al alm. 1, desde esta nueva pantalla,  como codlote='PZ00762776' existe ya en alm. 3 no puede existir otro codlote igual, por lo que genera un PZ00762776.1 (aunque sea en el alm. 1), dejando pues a entender que la pieza originaria de todo es PZ00762776 del alm.3 y el resto son transferencias de piezas entre almacenes. (si este nuevo codlote existe en alm. destino es añadir cantidades al lote y recalcular)_

    _En el ejemplo rápido de arriba también, si PZ00762769.CN02, se transfiere a alm. CN03, como PZ00762769 existe ya en un almacen (en este caso el 1, pero podría se otro), se genera el nuevo codlote con la forma, (codlotede10digitos.codalmacendestino) en este caso PZ00762769.CN03 (si este nuevo codlote existe en alm. destino es añadir cantidades al lote y recalcular)_


### Asignar piezas a la transferencia de piezas
Al pulsar el botón de "asignar piezas" dentro de la cabecera de "transferencias de piezas" se muestra un selector similar al selector de albaranes de venta > asignar piezas, pero con otra lógica y mejorado con el nuevo filtro de desde-hasta pieza. (Ver pantallazo del correo de JRuiz)

Clonaremos esa pantalla, modificando la lógica para que inserte líneas en líneas de transferencias de piezas y que al insertar las líneas vaya generando la lógica anterior de creación de movimientos.
    
Debe buscar las piezas en el alm.origen de la transferencia solamente (incluidos los filtros desde-hasta pieza)

La cantidad a transferir será el total físico de la pieza

Eliminaremos las columnas de cant.pedido y cant.pte de la nueva pantalla de selección.

## Tareas
* #EUR #H4455. Aumento de lotes a 15 caracteres y criterios de agregación del sufijo de almacén
* #EUR #H4455. Informes afectados
* #EUR #H4455. Nueva pantalla de transferencia de piezas
* #EUR #H4455. Asignar piezas a la transferencia de piezas
* #EUR #H4455. Lógica de creación de lote en almacén destino


## Tests
+ Pieza de almacén nativo a otro donde no existe (creación) (LLLLLLLLLL > LLLLLLLLLL.AAAA)
+ Pieza de almacén nativo a otro donde sí existe (uso del existente) (LLLLLLLLLL > LLLLLLLLLL.AAAA)
+ Pieza de almacén no nativo a otro donde no existe (creación) (LLLLLLLLLL.AAAA > LLLLLLLLLL.BBBB)
+ Pieza de almacén no nativo a otro donde sí existe (uso del existente) (LLLLLLLLLL.AAAA > LLLLLLLLLL.BBBB)
+ Pieza de almacén no nativo a almacén origen (uso del existente) (LLLLLLLLLL.AAAA > LLLLLLLLLL)